
#test:
#	@curl -N -X POST http://localhost:8080/execute \
#	  -H 'Content-Type: application/json' \
#	  -d '{"cmd":"ping","args":["-c","5","127.0.0.1"]}'
#
test2:
	@curl -N -X POST http://libreoffice-api:8080/execute \
	  -H 'Content-Type: application/json' \
	  -d '{"cmd":"ls","args":["-lh"]}'

include .env

build_proxy_clean := $(subst ",,$(build_proxy))
host_proxy_clean := $(subst ",,$(host_proxy))
env_proxy_clean := $(subst ",,$(env_proxy))

# 项目名称和版本
PROJECT_NAME := command-api
VERSION := $(shell git describe --tags --always --dirty)

# 编译相关设置
#GO := go
#GOFMT := gofmt
#GOTEST := go test
#GOBUILD := go build
GOFILES := $(shell find . -name '*.go' | grep -v _test.go)

# 输出文件
BUILD_DIR := ./dist
BINARY := $(BUILD_DIR)/$(PROJECT_NAME)

# 默认目标
.PHONY: all
all: fmt deps test build  ## 格式化代码，运行测试并构建项目


# 编译项目
.PHONY: build
build:  ## 编译项目
	@echo "Building project..."
	@mkdir -p $(BUILD_DIR)
	#go build -ldflags "-X main.version=$(VERSION)" -o $(BINARY) .
	go build -o $(BINARY)

# 运行项目
.PHONY: run
run:  ## 运行项目
	@echo "Running project..."
	go run .

# 测试项目
.PHONY: test
test:  ## 运行测试
	@echo "Running tests..."
	go test ./...

# 格式化代码
.PHONY: fmt
fmt:  ## 格式化代码
	@echo "Formatting code..."
	gofmt -w $(GOFILES)

# 清理构建输出
.PHONY: clean
clean:  ## 清理构建输出
	@echo "Cleaning up..."
	rm -rf $(BUILD_DIR)

# 静态检查代码
.PHONY: vet
vet:  ## 静态检查代码
	@echo "Running go vet..."
	go vet ./...

# 生成二进制文件（适合发行版）
.PHONY: release
release: clean build  ## 构建发行版二进制文件
	@echo "Building release version..."

# 安装依赖
.PHONY: deps
deps:  ## 安装依赖
	@echo "Installing dependencies..."
	go mod tidy

# 构建 Docker 镜像
.PHONY: docker-build
docker-build:  ## 构建 Docker 镜像
	@echo "Building Docker image..."
	${host_proxy_clean} docker build -t $(PROJECT_NAME):$(VERSION) .

# 推送 Docker 镜像
.PHONY: docker-push
docker-push:  ## 推送 Docker 镜像
	@echo "Pushing Docker image..."
	docker push $(PROJECT_NAME):$(VERSION)

# 帮助信息
.PHONY: help
help:  ## 显示帮助信息
	@echo "Makefile commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  make %-15s %s\n", $$1, $$2}'

